# sherry3.5.1.2
#### Working software for my job, for replacing the manual work

import urllib3
import socket
import pandas as pd
import time
import os
import win32api
import win32con
from ctypes import *

## Scrapy engine
def DownLoad():
    try:
        headers = {'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36'}
        timeout = 90
        socket.setdefaulttimeout(timeout)
        http = urllib3.PoolManager()
        response = http.request('GET', url, headers=headers)
        with open(url_part + '.csv', 'wb') as f:
            f.write(response.data)
        print(csv_file_name)
    except:
        print("下载文件失败！！！")
        os.system("start C:\Biexiangta.mp3")
        os.system("start C:\下载文件失败.txt")
        pass

## Clipboard 
def addToClipBoard(text):
    command = 'echo ' + text.strip() + '| clip'
    os.system(command)

## Modify the Output of Power Control Platform
def AutoChangeMW():
    # Open teamviewer page
    windll.user32.SetCursorPos(459, 744)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTDOWN, 0, 0)
    time.sleep(0.05)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTUP, 0, 0)
    time.sleep(0.05)
    # Close teamviewer page
    windll.user32.SetCursorPos(855, 417)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTDOWN, 0, 0)
    time.sleep(0.05)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTUP, 0, 0)
    windll.user32.SetCursorPos(855, 417)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTDOWN, 0, 0)
    time.sleep(0.05)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTUP, 0, 0)
    time.sleep(0.5)
    windll.user32.SetCursorPos(785, 402)  
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTDOWN, 0, 0)
    time.sleep(0.05)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTUP, 0, 0)
    windll.user32.SetCursorPos(785, 402)  
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTDOWN, 0, 0)
    time.sleep(0.05)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTUP, 0, 0)
    time.sleep(0.8)
    # Open power settings
    windll.user32.SetCursorPos(370, 130)  
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTDOWN, 0, 0)
    time.sleep(0.05)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTUP, 0, 0)
    time.sleep(0.5)
    # Select
    windll.user32.SetCursorPos(655, 366)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTDOWN, 0, 0)
    time.sleep(0.05)
    # Delete 
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTUP, 0, 0)
    win32api.keybd_event(8, 0, 0, 0)
    time.sleep(0.05)
    win32api.keybd_event(8, 0, win32con.KEYEVENTF_KEYUP, 0)
    time.sleep(0.25)
    ## Record process of adjustment to txt files
    try:
        RecordFile = open(RecordFileName, 'a')
    except IOError:
        print('*** file open error:')
    else:
        RecordFile.write('\n' + str(time.strftime('%Y-%m-%d  %H:%M:%S', time.localtime(time.time()))) + '\n')
        if LMP >= 0:
            for Q in range(0, 3):
                addToClipBoard('61200')  # set the clipboard to '61200'
            RecordFile.write('New LMP is: ' + str(LMP) + ', please change the output to 61200' + '\n')
        else:
            for Q in range(0, 3):
                addToClipBoard('2000')  # set the clipboard to '2000'
            RecordFile.write('New LMP is: ' + str(LMP) + ', please change the output to 2000' + '\n')
        RecordFile.write('download the file' + csv_file_name + '\n')
        RecordFile.close()
    # Edit the output value
    win32api.keybd_event(17, 0, 0, 0)  # press 'ctrl'
    win32api.keybd_event(86, 0, 0, 0)  # 'v'
    win32api.keybd_event(86, 0, win32con.KEYEVENTF_KEYUP, 0)  # release the button
    win32api.keybd_event(17, 0, win32con.KEYEVENTF_KEYUP, 0)
    time.sleep(0.5)
    # Click OK
    windll.user32.SetCursorPos(726, 364)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTDOWN, 0, 0)
    time.sleep(0.05)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTUP, 0, 0)
    time.sleep(0.2)
    # Minimize teamviewer 
    windll.user32.SetCursorPos(459, 744)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTDOWN, 0, 0)
    time.sleep(0.05)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTUP, 0, 0)

## Start running
### initial values
LMP = -1111111111
record = 3
delay = 0
Delay = 0
DIFF = 3
R_csv_file_name = 'start'
recover = 0
BadPing = 0
FileBuild = 0
while(1):
    # Creat txt file
    RecordFileName = time.strftime('%Y%m%d', time.localtime(time.time())) + '_Record of Operation' + '.txt'
    if not os.path.exists(RecordFileName):
        if FileBuild == 0:
            RecordFile = open(RecordFileName, 'w')
            RecordFile.close()
            try:
                RecordFile = open(RecordFileName, 'a') 
            except IOError:
                print('*** file open error:')
            else:
                RecordFile.write('\n' + '\n' + '***  ' + str(time.strftime('%Y-%m-%d', time.localtime(time.time()))) + '  records of monitoring the LMP' + '  ***' + '\n' + '\n')
                RecordFile.close() 
            FileBuild = 1
            
### make the file name 
    local_time = time.localtime(time.time())
    YEAR = time.strftime('%Y', local_time)
    MONTH = time.strftime('%m', local_time)
    DAY = time.strftime('%d', local_time)
    url_basis = 'https://marketplace.spp.org/file-api/download/rtbm-lmp-by-bus?path=%2F'+YEAR+'%2F'+MONTH+'%2FBy_Interval%2F' + DAY +'%2FRTBM-LMP-B-'

##### change the time
    second = float(time.strftime('%S', local_time))
    minute = (int(time.strftime('%M', local_time))) % 5
    # print(time.strftime("%Y-%m-%d   %H:%M:%S", time.localtime(time.time())))
    if ((second > 13) & (second <= 17)) | (((second > 41) & (second <= 44))&(minute < 3)): 
        url_part = time.strftime('%Y%m%d%H%M', time.localtime(time.time() - (time.time() % 300) + 300))  # min+5
        url = url_basis + url_part + '.csv'
        csv_file_name = url_part + '.csv'

#### start the python engnine
        exit_code = os.system('ping www.google.com')
        if exit_code:
            if BadPing == 0:
                os.system("start C:\Biexiangta.mp3")
                os.system("start C:\network interruption.txt")
                try:
                    RecordFile = open(RecordFileName, 'a')
                except IOError:
                    print('*** file open error:')
                else:
                    RecordFile.write('\n' + str(time.strftime('%Y-%m-%d  %H:%M:%S', time.localtime(time.time()))) + '\n')
                    RecordFile.write('Waiting for re-connecting the internet……' + '\n')
                    RecordFile.close()
                BadPing = BadPing + 1
            time.sleep(6)
        else:
            BadPing = 0
            # user_agent = 'Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)'
            # headers = {'User-Agent': user_agent}
            if os.path.exists(csv_file_name):
                if not os.path.getsize(csv_file_name):
                    DownLoad()
            else:
                DownLoad()

### Post-process the downloaded file
#### read csv
            if os.path.getsize(csv_file_name):
                file_data = pd.read_csv(csv_file_name, usecols=['Interval', 'Pnode', 'LMP'], encoding='gbk')
#### find cirruswind
                for find_i in range(0, file_data.shape[0]):
                    CIRRUSWIND = file_data.loc[find_i]
                    if 'CIRRUS' in CIRRUSWIND[1]:
                        Time = CIRRUSWIND[0]
                        Name = CIRRUSWIND[1]
                        LMP = CIRRUSWIND[2]
#### judge the LMP 
                if LMP >= 0:
                    judgement = 1
                else:
                    judgement = 0
                diff = record - judgement
                print('record=', record, 'judgement=', judgement, 'diff =', diff)
                if record == 3:
                    try:
                        RecordFile = open(RecordFileName, 'a')
                    except IOError:
                        print('*** file open error:')
                    else:
                        RecordFile.write('\n' + str(time.strftime('%Y-%m-%d  %H:%M:%S', time.localtime(time.time()))) + '\n')
                        if LMP >= 0:
                            RecordFile.write('The program starts to run, now LMP is: ' + str(LMP) + '. Please keep the output being 61200' + '\n')
                        else:
                            RecordFile.write('The program starts to run, now LMP is: ' + str(LMP) + '. Please keep the output being 2000' + '\n')
                        RecordFile.write('Download the file: ' + csv_file_name + '\n')
                        RecordFile.close()
                    AutoChangeMW()  
#### weighted delay
                if (judgement != record) | ((diff == 0) & (DIFF != 3) & (delay != 0) & (DIFF != 2)&(R_csv_file_name != csv_file_name)):
                    if record != 3:
                        recover = 0
                        try:
                            RecordFile = open(RecordFileName, 'a')
                        except IOError:
                            print('*** file open error:')
                        else:
                            RecordFile.write('\n' + str(time.strftime('%Y-%m-%d  %H:%M:%S', time.localtime(time.time()))) + '\n')
                            if judgement != record:
                                RecordFile.write('Positive/Negative changing happens, new LMP: ' + str(LMP) + '\n')
                            else:
                                RecordFile.write('Keep observing, new LMP: ' + str(LMP) + '\n')
                            RecordFile.write('Download the file: ' + csv_file_name + '\n')
                            RecordFile.close()
#### Recover
                        if (DIFF != diff) & (diff != 0) & (DIFF != 2) & (DIFF != 3) & (Delay < 4) & (delay > 0):
                            delay = 0
                            print('Recover it，delay=', delay)
                            recover = 1
                            try:
                                RecordFile = open(RecordFileName, 'a')
                            except IOError:
                                print('*** file open error:')
                            else:
                                RecordFile.write('\n' + str(time.strftime('%Y-%m-%d  %H:%M:%S', time.localtime(time.time()))) + '\n')
                                RecordFile.write('Please ignore the last fluctuation, new LMP: ' + str(LMP) + '\n')
                                RecordFile.write('Download the file: ' + csv_file_name + '\n')
                                RecordFile.close()
                        print('record=', record, 'judgement=', judgement, 'diff =', diff)
#### delay intervals
                        if recover == 0:
                            if abs(LMP) <= 2.5:
                                delay = delay + 0.5
                                print('delay=', delay)
                            elif (abs(LMP) > 2.5) & (abs(LMP) <= 5):
                                delay = delay + 1
                                print('delay=', delay)
                            elif abs(LMP) > 10:
                                delay = delay + 4
                                print('delay=', delay)
                            else:
                                delay = delay + 2
                                print('delay=', delay)
#### alert
                        Delay = delay
                        print('Delay=', Delay)
                        if Delay >= 4:
                            print('delay=', delay)
                            print('delay>=4, Play the music')
                            os.system("start C:\shimian.mp3") 
                            delay = 0
                            ## modify the output
                            AutoChangeMW()
                elif R_csv_file_name != csv_file_name:
                    try:
                        RecordFile = open(RecordFileName, 'a')  
                    except IOError:
                        print('*** file open error:')
                    else:
                        RecordFile.write('\n' + str(time.strftime('%Y-%m-%d  %H:%M:%S', time.localtime(time.time()))) + '\n')
                        RecordFile.write('No operation. Now LMP is: ' + str(LMP) + '\n')
                        RecordFile.write('Download the file: ' + csv_file_name + '\n')
                        RecordFile.close()
                record = judgement
                DIFF = diff
                R_csv_file_name = csv_file_name
                print('LMP=', LMP)
                print('record=', record, 'judgement=', judgement)
                print('DIFF=', DIFF)
                print('Delay=', Delay)
                print('recover=', recover)
                time.sleep(2)
    print(time.strftime("%Y-%m-%d   %H:%M:%S", time.localtime(time.time())), '  ', 'LMP=', LMP, '   ', 'Delay=', Delay, '   ', 'recover=', recover)
